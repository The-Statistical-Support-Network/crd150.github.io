<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Lab 8: Opportunity Mapping</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">CRD 150: Winter 2020</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="syllabus.html">Syllabus</a>
</li>
<li>
  <a href="hw_guidelines.html">Assignment Guidelines</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Labs/Assignments
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lab1.html">Lab 1</a>
    </li>
    <li>
      <a href="lab2.html">Lab 2</a>
    </li>
    <li>
      <a href="lab3.html">Lab 3</a>
    </li>
    <li>
      <a href="lab4.html">Lab 4</a>
    </li>
    <li>
      <a href="lab5.html">Lab 5</a>
    </li>
    <li>
      <a href="lab6.html">Lab 6</a>
    </li>
    <li>
      <a href="lab7.html">Lab 7</a>
    </li>
    <li>
      <a href="lab8.html">Lab 8</a>
    </li>
    <li>
      <a href="lab9.html">Lab 9</a>
    </li>
    <li>
      <a href="qgis.html">Extra Lab - QGIS</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="eligible.html">Eligible Communities</a>
    </li>
    <li>
      <a href="ndata.html">Neighborhood Data Sources</a>
    </li>
    <li>
      <a href="bigopendata.html">Big and Open Data Sources</a>
    </li>
    <li>
      <a href="nhgis.html">Using NHGIS</a>
    </li>
    <li>
      <a href="policymap.html">Using PolicyMap</a>
    </li>
    <li>
      <a href="missingdata.html">Missing Data</a>
    </li>
    <li>
      <a href="georeferencing.html">Mapping Coordinates</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Lab 8: Opportunity Mapping</h1>
<h3 class="subtitle"><h4 style="font-style:normal">
CRD 150 - Quantitative Methods in Community Research
</h4></h3>
<h4 class="author"><h4 style="font-style:normal">
Professor Noli Brazil
</h4></h4>
<h4 class="date"><h4 style="font-style:normal">
February 28, 2020
</h4></h4>

</div>


<style>
p.comment {
background-color: #DBDBDB;
padding: 10px;
border: 1px solid black;
margin-left: 25px;
border-radius: 5px;
font-style: italic;
}

.figure {
   margin-top: 20px;
   margin-bottom: 20px;
}

h1.title {
  font-weight: bold;
  font-family: Arial;  
}

h2.title {
  font-family: Arial;  
}

</style>
<style type="text/css">
#TOC {
  font-size: 13px;
  font-family: Arial;
}
</style>
<p><br />
</p>
<p>In this guide you will learn how to condense a suite of neighborhood variables into a numeric opportunity index. The objectives of the guide are as follows.</p>
<ol style="list-style-type: decimal">
<li>Understand the data workflow for computing opportunity indices</li>
<li>Learn about standardization</li>
<li>Create and map a numeric index of opportunity</li>
</ol>
<p>To accomplish these objectives, we will use data from the UC Davis <a href="https://regionalchange.ucdavis.edu/">Center for Regional Change</a> <a href="https://interact.regionalchange.ucdavis.edu/roi/data.html">Regional Opportunity Index</a>. This lab guide follows closely the material presented in class Handout 5.</p>
<p class="comment" , style="font-style:normal">
<strong>Assignment 8 is due by 11:59 pm, March 5th on Canvas.</strong> See <a href="https://crd150.github.io/hw_guidelines.html">here</a> for assignment guidelines. You must submit an <code>.Rmd</code> file and its associated <code>.html</code> file. Name the files: yourLastName_firstInitial_asgn08. For example: brazil_n_asgn08.
</p>
<div style="margin-bottom:25px;">

</div>
<div id="open-up-a-r-markdown-file" class="section level2">
<h2><strong>Open up a R Markdown file</strong></h2>
<p><br />
Download the <a href="https://raw.githubusercontent.com/crd150/data/master/labtemplate.Rmd">Lab template</a> into an appropriate folder on your hard drive (preferably, a folder named ‘Lab 8’), open it in R Studio, and type and run your code there. Change the title (“Lab 8”) and insert your name and date. Don’t change anything else inside the YAML (the stuff at the top in between the <code>---</code>).</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="installing-and-loading-packages" class="section level2">
<h2><strong>Installing and loading packages</strong></h2>
<p><br />
We will not be introducing any new packages in this lab, so no installing.</p>
<p>You’ll need to load the following packages. Unlike installing, you will always need to load packages whenever you start a new R session. You’ll also always need to use <code>library()</code> in your R Markdown file.</p>
<pre class="r"><code>library(tidyverse)
library(sf)
library(tigris)
options(tigris_class = &quot;sf&quot;)
library(tmap)</code></pre>
<p>If you get an error indicating that any of the above packages do not exist, install them (once and never again).</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="workflow" class="section level2">
<h2><strong>Workflow</strong></h2>
<p><br />
As fully discussed in Handout 5, the basic workflow for creating an opportunity index or typology is as follows</p>
<ol style="list-style-type: decimal">
<li>Establish the theoretical framework based on an extensive literature review and, if possible, feedback from community members</li>
<li>Collect data on variables that capture important contextual features of a neighborhood based on each subdomain</li>
<li>Clean, process, and transform input variables</li>
<li>Select modelling approach</li>
<li>Run, refine, alter and expand model</li>
<li>Map your index</li>
</ol>
<p>Following this workflow, we’re going to recreate the <a href="https://interact.regionalchange.ucdavis.edu/roi/data.html">Regional Opportunity Index</a> (ROI), which is a numeric index of opportunity for California neighborhoods created by the <a href="https://regionalchange.ucdavis.edu/">Center for Regional Change</a> (CRC) at UC Davis.</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="regional-opportunity-index" class="section level2">
<h2><strong>Regional Opportunity Index</strong></h2>
<p><br />
Using census tract data and a combination of people and place-based indicators relating to education, economy, housing, mobility/transportation, health, and civic life, the CRC’s Regional Opportunity Index (ROI) assesses factors driving community and regional opportunity and well-being. The index, which includes an <a href="https://interact.regionalchange.ucdavis.edu/roi/webmap/webmap.html">online mapping tool</a>, is intended to help banks, policymakers, and advocates identify the most vulnerable communities for investment and policy efforts. See examples of its applications <a href="https://viewperformance.deltacouncil.ca.gov/pm/delta-economy">here</a>, <a href="https://www.shfcenter.org/assets/SJVHF/SJV_Mapping_Opportunity_Report_Feb_2015.pdf">here</a>, and <a href="https://www.tandfonline.com/doi/full/10.1080/21513732.2017.1412355">here</a></p>
<p>The variables that were chosen to construct the index were based on a critical review of the literature, which accomplishes step 1 in the above workflow. Because this is a quantitative class, we’re not going to go through how the CRC accomplished this step, but as was discussed in Handout 1, one’s theoretical framework sets the table for the rest of the analysis, which also applies to the creation of an opportunity index, and thus step 1 is not to be taken lightly.</p>
<p>The CRC also took care of step 2 for us. This step is also non-trivial. If you go through the ROI <a href="https://interact.regionalchange.ucdavis.edu/roi/Download_Data/ROI%20Metadata.pdf">methodology</a>, you will find that they took data of all types from an assortment of sources. Finding the data, downloading it, and wrangling it to the form that they needed required an enormous amount of effort and time.</p>
<p>We’ll bring into R the underlying 2014 tract-level data that make up the ROI. Bring in the data, which are available on Github.</p>
<pre class="r"><code>roi.tract.data &lt;- read_csv(&quot;https://raw.githubusercontent.com/crd150/data/master/roi_data_2014.csv&quot;)</code></pre>
<p><br></p>
<p>The variables correspond to different place dimensions: Education, Economic, Housing, Health/Environment, and Civic Life. Detailed information on these domains and their variables can be found on the <a href="https://interact.regionalchange.ucdavis.edu/roi/Download_Data/ROI%20Metadata.pdf">ROI website</a>. You can view the record layout for the variables in <em>roi.tract.data</em> <a href="https://raw.githubusercontent.com/crd150/data/master/record_layout.xlsx">here</a>. Note that the ROI has two indices: one for people and another for place. We will be working on data for the place index.</p>
<p>The data are largely cleaned, so step 3 is mostly done. This includes converting variable counts to percentages, ratios, and rates where appropriate. There is some missingness in the data. Rather than using the techniques outlined in the missing data <a href="https://crd150.github.io/missingdata.html">minilab</a> to fill in this missingness, let’s follow the CRC and not impute for it. This means that when we calculate values like the mean or standard deviation, we need to use the option <code>na.rm=TRUE</code> within the command. Also, we’ll have gray areas designating tracts with missing data when we map.</p>
<p>The CRC did a lot of the heavy lifting by selecting, collecting and cleaning the data. But, we still have a few data wrangling tasks to take care of.</p>
<div style="margin-bottom:25px;">

</div>
<div id="variables-point-in-the-same-direction" class="section level3">
<h3><strong>Variables point in the same direction</strong></h3>
<p><br />
As described in section 4.2 in Handout 5, we need to make sure all the variables point in the same direction. Higher values on an opportunity index should mean more opportunity. This means the variables used in the index should also be scaled that way. With the ROI data, we have two variables that we need to rescale. First, the variable <em>edplc4</em> is the percentage of high school students in the school district who were suspended or expelled. Higher values here indicate lower opportunity, but we want the reverse. For percentages, you need to subtract them from 100. Variables on other scales are inverted by taking the reciprocal of the variable (1 divided by the value). The other variable in the data set that needs inversion is <em>enplc4</em>, the annual mean concentration of PM2.5 (exposure to pollution).</p>
<p>We use the <code>mutate()</code> function to make these transformations.</p>
<pre class="r"><code>roi.tract.data &lt;- mutate(roi.tract.data, edplc4 = 100-edplc4, enplc4 = 1/enplc4) </code></pre>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="standardizing-variables" class="section level3">
<h3><strong>Standardizing variables</strong></h3>
<p><br />
In order to combine variables into an index, we need to standardize them, which is described in section 4.3 in the handout. We do this to get the variables onto the same scale. That is, variables are measured across multiple measurement scales, from percentages such as percent non-Hispanic black to ratios such as population density, and we need to get these variables on the same scale. A common approach to standardizing a variable is to calculate its z-score. The z-score is a measure of distance from the mean, in this case the mean of all tracts in an area. So, after standardization, the variables will have the same units, specifically units of standard deviations.</p>
<p>Let’s calculate the z-score for the variable <em>hsplc1</em> (% of households with no more than 1 occupant per room) using equation 1 in Handout 5. Relying on our compadre <code>mutate()</code>, we can create a variable named <em>hsplc1z</em> that subtracts the total mean of <em>hsplc1</em> from each tract’s value on <em>hsplc1</em> and then divide by the standard deviation of <em>hsplc1</em>. The ROI uses the California mean, but read the section “Standardize variables using the appropriate comparison mean” in the Handout to understand the potential issues with using the statewide mean.</p>
<pre class="r"><code>roi.tract.data %&gt;%
  mutate(hsplc1z = (hsplc1-mean(hsplc1, na.rm=TRUE))/sd(hsplc1, na.rm=TRUE)) %&gt;%
  select(tract,hsplc1z)</code></pre>
<pre><code>## # A tibble: 8,035 x 2
##         tract hsplc1z
##         &lt;dbl&gt;   &lt;dbl&gt;
##  1 6001400100   0.867
##  2 6001400200   0.928
##  3 6001400300   0.928
##  4 6001400400   0.874
##  5 6001400500   0.828
##  6 6001400600   0.846
##  7 6001400700   0.422
##  8 6001400800   0.784
##  9 6001400900   0.664
## 10 6001401000   0.754
## # … with 8,025 more rows</code></pre>
<p>We just standardized <em>hsplc1</em>, but we need to do this for all variables in the data set. Standardizing one variable at a time by repeating the code above is fine and dandy if you have a small number of variables to standardize. But, for most opportunity indices, you’ll be dealing with a lot of variables. For example, the complete (place and people) ROI incorporates 31 variables. Yes, you can repeat the above code 31 times, but is there a more efficient way?</p>
<p>Why yes!</p>
<p>Instead of writing out the above code for every variable, we can use a combination of the <code>scale()</code> function, which is a canned function that standardizes a variable, and <code>mutate()</code>’s hidden yet very powerful sister <code>mutate_at()</code>. Let’s create a new tibble called <em>roi.std</em> that contains all 31 variables standardized using the following code.</p>
<pre class="r"><code>roi.std &lt;- mutate_at(roi.tract.data, scale, .vars = vars(-c(cntyfips, cntyname, tract, placenm)))</code></pre>
<p>Let’s break the above code down a bit so we’re all on the same page. The function <code>mutate_at()</code> tells R to run a function on all variables in the dataset. The first argument <em>roi.tract.data</em> is our dataset. The second argument is the name of our function <code>scale</code>.</p>
<p>If we ended our function there, we will get an error</p>
<pre class="r"><code>mutate_at(roi.tract.data, scale)</code></pre>
<pre><code>## Error: `.vars` must be a character/numeric vector or a `vars()` object, not a function</code></pre>
<p>Why? Because we have variables in our dataset that are characters. The larger issue, however, is that we have multiple variables, numeric and character, in our dataset <em>roi.tract.data</em> that we don’t need to standardize. This is why we use the <code>.vars = vars()</code> argument. The argument <code>.vars = vars(-c(cntyfips, cntyname, tract, placenm))</code> tells <code>mutate_at()</code> that R will execute <code>scale</code> for all variables in <em>roi.tract.data</em> <strong>except</strong> <em>cntyfips</em>, <em>cntyname</em>, <em>tract</em>, and <em>placenm</em>.</p>
<p>At this point in the quarter, you should now understand the power of the <strong>tidyverse</strong>. Instead of 31+ lines of code, we were able to complete the task of standardizing 31 variables in 1 line of code. Efficiency is next to godliness. Or something like that.</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="combining-into-domains" class="section level3">
<h3><strong>Combining into domains</strong></h3>
<p><br />
The next step is to calculate ROI domain indices by averaging the variables within each of the domains. ROI has five domains: Education, Economic, Housing, Health/Environment, and Civic Life. The crosswalk between variables and domains is provided in the <a href="https://raw.githubusercontent.com/crd150/data/master/record_layout.xlsx">record layout</a>. Let’s calculate the average for the Economic domain, which contains the variables <em>ecplc1</em>, <em>ecplc2</em>, <em>ecplc3</em>, and <em>ecplc4</em>. Add these and divide by 4 and we get the mean!</p>
<pre class="r"><code>roi.std &lt;- mutate(roi.std, Economic = (ecplc1+ecplc2+ecplc3+ecplc4)/4)</code></pre>
<p>Calculate the other domains (Education, Health/Environment, and Civic) and then average the domain specific averages to get an overall index. We’ll let you do this on your own.</p>
<p>Keep in mind that the Center for Regional Change computed a geometric mean instead of an arithmetic mean. In order to calculate the geometric mean, they had to use a method called Min-Max scaling to standardize variables. You can read more about Min-Max scaling and the geometric mean on page 25 in the <a href="https://interact.regionalchange.ucdavis.edu/roi/Download_Data/ROI%20Metadata.pdf">ROI methods document</a>.</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="mapping-the-indices" class="section level3">
<h3><strong>Mapping the indices</strong></h3>
<p><br />
We’ve got our indices, overall and by domain, so now it’s time to map them, which is the final step of the workflow. Let’s bring in a shapefile of California census tracts using the <code>tracts()</code> function from the <strong>tigris</strong> package.</p>
<pre class="r"><code>ca.tracts &lt;- tracts(&quot;CA&quot;) </code></pre>
<p>We want to merge the tibble <em>roi.std</em> into <em>ca.tracts</em>. The variable we want to merge on is <em>GEOID</em>, but it is a character in <em>ca.tracts</em> and a numeric in <em>roi.std</em>. To make them match, convert <em>GEOID</em> into a numeric in <em>ca.tracts</em>.</p>
<pre class="r"><code>ca.tracts &lt;-  mutate(ca.tracts, tract = as.numeric(GEOID))</code></pre>
<p>Next, we merge using <code>left_join()</code>.</p>
<pre class="r"><code>ca.tracts &lt;- left_join(ca.tracts, roi.std, by = &quot;tract&quot;)</code></pre>
<p>Following how the ROI is <a href="https://interact.regionalchange.ucdavis.edu/roi/webmap/webmap.html">presented</a> online, we break the numeric indices into quintiles (five equal groups) where the top 20% indicates highest opportunity and the bottom 20% represents lowest opportunity. We’ll cut the <em>Economic</em> variable into quintiles using the <code>cut()</code> and <code>quantile()</code> commands within <code>mutate()</code>.</p>
<pre class="r"><code>ca.tracts &lt;- mutate(ca.tracts, EconomicQ = cut(Economic, breaks=quantile(Economic, c(0,0.2,0.4,0.6,0.8,1), na.rm=TRUE), include.lowest = TRUE))</code></pre>
<p>The above code creates a variable named <em>EconomicQ</em> in the dataset <em>ca.tracts</em> that breaks up the variable <em>Economic</em> into quintiles (top 20%, next 20%, … bottom 20%). The argument <code>include.lowest = TRUE</code> tells R to keep the lowest value (if you don’t specify this, the function <code>cut()</code> will ignore the lowest value).</p>
<p>Finally, we use <code>tm_shape()</code> to map the indices. Let’s put the map into view mode so we can zoom in and out of different areas of California.</p>
<pre class="r"><code>tmap_mode(&quot;view&quot;)</code></pre>
<p>Following the ROI, we will label the bottom 20% “Lowest Opportunity”, 20th-40th percentiles “Low”, 40th-60th percentiles “Moderate”, 60th-80th percentiles “High”, and 80th-100th percentiles “Highest Opportunity”.</p>
<pre class="r"><code>#this will take some time because you are mapping all of California
ca.map.ind.ec &lt;- tm_shape(ca.tracts) +
  tm_polygons(col = &quot;EconomicQ&quot;,  palette = &quot;BrBG&quot;,
              border.alpha = 0, title = &quot;Economic Opportunity&quot;, midpoint = NA, 
              labels = c(&quot;Lowest Opportunity&quot;, &quot;Low&quot;, &quot;Moderate&quot;, &quot;High&quot;, &quot;Highest Opportunity&quot;))

#add a basemap to give us some context
ca.map.ind.ec + tm_view(basemaps=&quot;OpenStreetMap&quot;)</code></pre>
<p><br></p>
<p>What is the Economic Opportunity landscape like in the City of Davis? Zoom in and find out.</p>
<p>We’ve just recreated the Regional Opportunity Index! Tell <a href="https://regionalchange.ucdavis.edu/people/jonathan-k-london">Dr. London</a> when you take his class or see him in the hallways. He’ll be proud (and might hire you!).</p>
<hr />
<p><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
<p>Website created and maintained by <a href="https://nbrazil.faculty.ucdavis.edu/">Noli Brazil</a></p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>


</body>
</html>
